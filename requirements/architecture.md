# Архитектура AI-Trainer

## Обзор системы

```
┌─────────────────────────────────────────────────────────────┐
│                        КЛИЕНТ (React)                       │
│                                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │
│  │ QuizPage │  │ History  │  │ Settings │  │ Debug Mode │  │
│  │          │  │   Page   │  │   Page   │  │  (toggle)  │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └─────┬──────┘  │
│       │              │             │              │         │
│       └──────────────┴─────────────┴──────────────┘         │
│                          │                                  │
│                    API Client (fetch)                        │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTP (proxy :5173 → :3001)
┌──────────────────────────┴──────────────────────────────────┐
│                      СЕРВЕР (Express)                        │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                     Routes                            │   │
│  │  /api/quiz/evaluate    — оценка ответа               │   │
│  │  /api/quiz/:id/override — teacher override            │   │
│  │  /api/flashcards/*     — карточки                    │   │
│  │  /api/sessions/*       — сессии                      │   │
│  │  /api/settings/*       — настройки провайдера        │   │
│  │  /api/logs/export      — экспорт логов               │   │
│  └───────────────────────┬──────────────────────────────┘   │
│                          │                                  │
│  ┌───────────────────────┴──────────────────────────────┐   │
│  │               SLM Service Layer                       │   │
│  │                                                       │   │
│  │  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐  │   │
│  │  │   Prompt     │  │  Evaluation  │  │  Claude CLI │  │   │
│  │  │   Builder    │  │   (SLM)      │  │  (арбитр)   │  │   │
│  │  │             │  │              │  │             │  │   │
│  │  │ few-shot    │  │ Groq/Ollama  │  │ child_proc  │  │   │
│  │  │ injection   │  │ HTTP API     │  │ stdin/stdout│  │   │
│  │  └─────────────┘  └──────────────┘  └─────────────┘  │   │
│  └───────────────────────────────────────────────────────┘   │
│                          │                                  │
│  ┌───────────────────────┴──────────────────────────────┐   │
│  │                   SQLite (sql.js)                     │   │
│  │                                                       │   │
│  │  flashcards │ flashcard_answers │ sessions             │   │
│  │  interactions │ prompt_examples │ provider_config      │   │
│  └───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                           │                    │
                    ┌──────┴──────┐      ┌──────┴──────┐
                    │  Groq API   │      │ Ollama      │
                    │  (облако)   │      │ (локально)  │
                    └─────────────┘      └─────────────┘
```

## Поток оценки ответа (Evaluation Flow)

```
Студент вводит ответ
        │
        ▼
POST /api/quiz/evaluate
  { session_id, flashcard_id, user_answer, debug }
        │
        ▼
┌─────────────────────┐
│ Загрузка данных      │
│ • flashcard          │
│ • all answers (1+N)  │
│ • few-shot examples  │
│ • provider config    │
└─────────┬───────────┘
          │
    ┌─────┴─────────────────────┐
    │                           │
    ▼                           ▼ (только debug=true)
┌──────────────┐      ┌──────────────────┐
│  SLM (Groq)  │      │  Claude CLI      │
│              │      │                  │
│ system prompt│      │ расширенный      │
│ + few-shot   │      │ промпт:          │
│ + user msg   │      │ verdict +        │
│              │      │ comment +        │
│ ~300-500ms   │      │ explanation      │
│              │      │                  │
│              │      │ ~3-10s           │
└──────┬───────┘      └────────┬─────────┘
       │                       │
       └───────────┬───────────┘
                   ▼
         ┌──────────────────┐
         │ Сохранение в БД  │
         │ (interactions)   │
         └────────┬─────────┘
                  │
                  ▼
         ┌──────────────────┐
         │ Ответ клиенту    │
         │                  │
         │ Student: verdict │
         │ Debug: + claude  │
         │ + prompt + raw   │
         │ + reference      │
         └──────────────────┘
```

## Feedback Loop (Teacher Override → Few-Shot)

```
                    Teacher Override
                          │
                          ▼
              ┌───────────────────────┐
              │ Преподаватель нажимает │
              │ Correct / Partial /   │
              │ Incorrect             │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ verdict отличается    │──── Нет ──→ Только сохраняем
              │ от SLM?              │              teacher_override
              └───────────┬───────────┘
                          │ Да
                          ▼
              ┌───────────────────────┐
              │ Создаём запись в      │
              │ prompt_examples:      │
              │                       │
              │ question              │
              │ reference_answer      │
              │ user_answer           │
              │ expected_verdict      │
              │ reason                │
              └───────────┬───────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Следующий запрос SLM  │
              │ включает этот пример  │
              │ в system prompt       │
              │                       │
              │ Лимит: 10 последних   │
              │ активных примеров     │
              └───────────────────────┘
```

## Модель данных

```
┌──────────────────┐       ┌───────────────────────┐
│   flashcards     │       │  flashcard_answers     │
├──────────────────┤       ├───────────────────────┤
│ id (PK)          │◄──────│ flashcard_id (FK)      │
│ question         │       │ id (PK)               │
│ answer (основной)│       │ answer (альтернативный)│
│ source           │       │ label                 │
│ created_at       │       │ created_at            │
└────────┬─────────┘       └───────────────────────┘
         │
         │ flashcard_id
         ▼
┌──────────────────────────────┐       ┌──────────────────┐
│        interactions           │       │    sessions       │
├──────────────────────────────┤       ├──────────────────┤
│ id (PK)                      │       │ id (PK)          │
│ session_id (FK) ─────────────┼──────►│ started_at       │
│ flashcard_id (FK)            │       │ finished_at      │
│ user_answer                  │       │ provider         │
│ slm_verdict / comment / raw  │       │ model            │
│ claude_verdict / comment     │       └──────────────────┘
│ claude_explanation / raw     │
│ teacher_override             │
│ prompt_sent                  │
│ provider / model             │
│ prompt_tokens / completion   │
│ latency_ms / claude_latency  │
│ created_at                   │
└──────────────────────────────┘

┌──────────────────────────┐       ┌──────────────────┐
│    prompt_examples        │       │ provider_config   │
├──────────────────────────┤       ├──────────────────┤
│ id (PK)                  │       │ id (PK, =1)      │
│ question                 │       │ provider         │
│ reference_answer         │       │ model            │
│ user_answer              │       │ base_url         │
│ expected_verdict         │       └──────────────────┘
│ reason                   │
│ active (0/1)             │
│ created_at               │
└──────────────────────────┘
```

## Два режима UI

```
┌─────────────────────────────────────────────────┐
│  Student Mode (debug=false)                      │
│                                                  │
│  ┌─────────────────────────────────────────┐     │
│  │ Question Card                           │     │
│  │ "Что такое AGI?"                        │     │
│  └─────────────────────────────────────────┘     │
│  ┌─────────────────────────────────────────┐     │
│  │ Answer Input                            │     │
│  │ [textarea]            [Submit]          │     │
│  └─────────────────────────────────────────┘     │
│  ┌─────────────────────────────────────────┐     │
│  │ ✓ CORRECT          438ms               │     │
│  │ Студент правильно передал суть...       │     │
│  │ groq / llama-3.1-8b-instant             │     │
│  └─────────────────────────────────────────┘     │
└──────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────┐
│  Debug Mode (debug=true)                          │
│                                                   │
│  [Question + Answer — то же что выше]             │
│                                                   │
│  ┌── SLM Evaluation ──────────────────────────┐   │
│  │ ✓ CORRECT  438ms                           │   │
│  │ [▶ Full Prompt Sent to SLM]                │   │
│  │ [▶ Raw SLM Response]                       │   │
│  │ Tokens: 317 prompt / 52 completion         │   │
│  └────────────────────────────────────────────┘   │
│  ┌── Claude Evaluation ───────────────────────┐   │
│  │ ✓ CORRECT  5946ms                          │   │
│  │ Ответ верный, ключевая идея передана...    │   │
│  │ ┃ Подробное объяснение: студент правильно  │   │
│  │ ┃ определил... отсутствие примеров не...   │   │
│  └────────────────────────────────────────────┘   │
│  ┌── Reference Answer ────────────────────────┐   │
│  │ Стандартизированный набор задач для...      │   │
│  └────────────────────────────────────────────┘   │
│  ┌── Teacher Override ────────────────────────┐   │
│  │ Если оценка SLM неверна, преподаватель...  │   │
│  │ [Correct] [Partial] [Incorrect]            │   │
│  └────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────┘
```
